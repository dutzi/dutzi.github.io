{"componentChunkName":"component---src-templates-blog-post-js","path":"/building-how-dep/","result":{"data":{"site":{"siteMetadata":{"title":"Things I've Learnt"}},"markdownRemark":{"id":"8a4e39c5-75e6-5df7-a439-bcaa0411499a","excerpt":"How-dep is a CLI tool that analyzes your TypeScript1 project, counting how many imports it encounters per each module your project depends on. How-dep generates…","html":"<p><a href=\"https://github.com/dutzi/how-dep\"><strong>How-dep</strong></a> is a CLI tool that analyzes your TypeScript<sup>1</sup> project, counting how many imports it encounters per each module your project depends on.</p>\n<p>How-dep generates both a CLI report and a living, breathing HTML report. <a href=\"https://dutzi.github.io/how-dep/example-report\">Here’s</a> an example of one.</p>\n<p>To run how-dep, first install it (<code class=\"language-text\">yarn global add how-dep</code>), then run it in your project’s root folder (<code class=\"language-text\">how-dep</code>).</p>\n<p>Here’s the gist of what I’ve learnt building it.</p>\n<h2>Statically Analyzing a TypeScript File</h2>\n<!-- Or, **Easily Traversing and Querying a TS File** -->\n<p>First, I needed a way to get all the module <code class=\"language-text\">imports</code> within a project. TS Query seemed pretty useful for that cause.</p>\n<p><a href=\"https://github.com/phenomnomnominal/tsquery\">TS Query</a> is a tool that allows you to query a TypeScript file for nodes (AST nodes), using a CSS selector-ish type syntax.</p>\n<p>For example, running the following query will return all the functions who’s name is “foo” (or more accurately, the nodes of the <em>names</em> of the functions)</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">FunctionDeclaration <span class=\"token operator\">></span> Identifier<span class=\"token punctuation\">[</span>name<span class=\"token operator\">=</span><span class=\"token string\">\"foo\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span>first<span class=\"token operator\">-</span>child</code></pre></div>\n<p>You can play with it <a href=\"https://tsquery-playground.firebaseapp.com/\">here</a>, it’s pretty cool.</p>\n<p>Using TS Query I was able to easily find all import statements and generate a report accordingly.</p>\n<h2>Rendering An HTML File From The CLI</h2>\n<!-- ### Utilizing React's SSR abilities to generate simple HTML file -->\n<p>Rendering a report <em>to</em> the CLI is easy, simply log whatever you want and use <a href=\"https://github.com/chalk/chalk\">chalk</a> to color it up. Rendering an HTML report is not too complicated either, when utilizing React’s SSR abilities.</p>\n<p>After creating a simple React based report (<strong><a href=\"https://github.com/dutzi/how-dep/blob/master/src/web/App.tsx\">the app</a></strong>), I needed a way to dump it out into an HTML file and present it to the user. <code class=\"language-text\">renderToString</code> was a simple way to do it.</p>\n<p><code class=\"language-text\">ReactDOMServer.renderToString</code> will take a React Element, and spit out the HTML that renders that node.</p>\n<p>Dump its output to a temporary file, give it a name, and you have a static page that renders your app:</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">import</span> ReactDOMServer <span class=\"token keyword\">from</span> <span class=\"token string\">'react-dom/server'</span>\n<span class=\"token keyword\">import</span> fs <span class=\"token keyword\">from</span> <span class=\"token string\">'fs-extra'</span>\n<span class=\"token keyword\">import</span> tempDirectory <span class=\"token keyword\">from</span> <span class=\"token string\">'temp-dir'</span>\n\n<span class=\"token comment\">// ...</span>\n\n<span class=\"token keyword\">const</span> outputHTML <span class=\"token operator\">=</span> ReactDOMServer<span class=\"token punctuation\">.</span><span class=\"token function\">renderToString</span><span class=\"token punctuation\">(</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">App</span></span> <span class=\"token attr-name\">data</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>data<span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">App</span></span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> outputFilePath <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>tempDirectory<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">/how-dep-report.html</span><span class=\"token template-punctuation string\">`</span></span>\n\nfs<span class=\"token punctuation\">.</span><span class=\"token function\">writeFileSync</span><span class=\"token punctuation\">(</span>outputFilePath<span class=\"token punctuation\">,</span> outputHTML<span class=\"token punctuation\">)</span></code></pre></div>\n<!-- ## hydrate -->\n<h2>Bringing Your Static HTML to Life</h2>\n<p>When rendering using React’s <code class=\"language-text\">renderToString</code> you end up with an HTML file, all your hooks and event listeners are not part of it, the HTML only contains the markup that’s needed to render the app on the client side <em>until</em> the JS bundle that brings it to life arrives. To bring your React app to life you’ll have to:</p>\n<ol>\n<li>Load ReactDOM from the dumb HTML file</li>\n<li>Load the React app (we’ll bundle it using Webpack)</li>\n<li>Run <code class=\"language-text\">ReactDOM.hydrate</code>, passing it the app and the HTML node the app is currently rendered in</li>\n</ol>\n<p>So, first, lets bundle ReactDOM and the app we’ve made and dump it with all the rest into our dumb HTML file, to do that we’ll use Webpack.</p>\n<p>Out of the box Webpack comes with sensible defaults, enough for us to simply give it an entry file, an output path and watch it bundle it up.</p>\n<p>Since I’m not an animal, I’ve used TypeScript when building how-dep, but since I’m too lazy to create a <code class=\"language-text\">webpack.config.js</code> file, I’ve used the TypeScript compiler to generate the JS files by adding the following to my package.json scripts map:</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\">  <span class=\"token property\">\"build:watch\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"tsc --watch\"</span></code></pre></div>\n<p>I’ve set TSC to transpile the TS files into a folder named “dist”.</p>\n<p>Then, I’ve added the following scripts to my package.json:</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\">  <span class=\"token property\">\"webpack:build\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"webpack dist/web/App.js --mode=production -o ./dist/web/bundle.js\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"webpack:watch\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"npm run webpack:build -- --watch\"</span></code></pre></div>\n<p>The first one runs Webpack on <code class=\"language-text\">App.js</code>, bundling it and all its dependencies into <code class=\"language-text\">dist/web/bundle.js</code>, the second one simply runs the first one in <strong>watch mode</strong>.</p>\n<p>I’ve also added the following script:</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\">  <span class=\"token property\">\"start\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"concurrently \\\"npm:build:watch\\\" \\\"npm:webpack:watch\\\"\"</span><span class=\"token punctuation\">,</span></code></pre></div>\n<p>Which uses <a href=\"https://github.com/kimmobrunfeldt/concurrently\">Concurrently</a> to run both npm scripts at the same time, this was useful when developing how-dep, greatly improving the feedback loop.</p>\n<p>So now that we’ve got TSC and Webpack up and running, we have a bundled JS file we can consume from our dumb HTML report file so we can bring it life.</p>\n<p>To consume the bundled JS we’ll simply place it within a <code class=\"language-text\">&lt;script&gt;</code> tag which we’ll render using the <code class=\"language-text\">renderToString</code> call we made earlier.</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">const</span> ouputHTML <span class=\"token operator\">=</span> ReactDOMServer<span class=\"token punctuation\">.</span><span class=\"token function\">renderToString</span><span class=\"token punctuation\">(</span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span>\n      <span class=\"token attr-name\">dangerouslySetInnerHTML</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span>\n        __html<span class=\"token punctuation\">:</span> fs\n          <span class=\"token punctuation\">.</span><span class=\"token function\">readFileSync</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span>__dirname<span class=\"token punctuation\">,</span> <span class=\"token string\">'/web/bundle.js'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span></span>\n    <span class=\"token punctuation\">></span></span><span class=\"token plain-text\"></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">App</span></span> <span class=\"token attr-name\">data</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>data<span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">App</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n  </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<p>Now, our HTML contains our bundled app, we just need to call <code class=\"language-text\">ReactDOM.hydrate</code> once it loads.</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">NODE_ENV</span> <span class=\"token operator\">===</span> <span class=\"token string\">'production'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  window<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'load'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    ReactDOM<span class=\"token punctuation\">.</span><span class=\"token function\">hydrate</span><span class=\"token punctuation\">(</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">App</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token punctuation\">,</span> document<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>A few things to note about the block above, first, we only run it in production mode, so that when how-dep renders the app (i.e., when the user runs <code class=\"language-text\">how-dep</code> from the CLI) that piece of code won’t run. We don’t want it to run since the CLI runs in Node which has no clue what <code class=\"language-text\">window</code> is.</p>\n<p>Second, adding the load event listener is simply good practice, it’s there so that no matter where I place that bundle’s <code class=\"language-text\">&lt;script&gt;</code> tag, it will only run <em>after</em> the the app’s markup has rendered.</p>\n<p>At this point, the app renders fine initially, but once React’s hydration starts the data is gone and nothing gets rendered.</p>\n<p>That’s because the app expects some props, which are now missing.</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token keyword\">function</span> <span class=\"token function\">App</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> data <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">// ...</span></code></pre></div>\n<p>To pass that data, we to add it serialize it and dump it out the HTML file.</p>\n<p>Adding the follwing <code class=\"language-text\">&lt;script&gt;</code> tag within the module responsible of rendering the HTML file will expose everything we need through an object on the window:</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token operator\">&lt;</span>script\n  dangerouslySetInnerHTML<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span>\n    __html<span class=\"token punctuation\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">window.__HOW_DEP = {\n      data: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">,\n    }</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n<span class=\"token operator\">></span><span class=\"token script\"></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>So now, revisiting our code from before, we can write:</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">NODE_ENV</span> <span class=\"token operator\">===</span> <span class=\"token string\">'production'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  window<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'load'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    ReactDOM<span class=\"token punctuation\">.</span><span class=\"token function\">hydrate</span><span class=\"token punctuation\">(</span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">App</span></span>\n<span class=\"gatsby-highlight-code-line\">        <span class=\"token attr-name\">data</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">(</span>window <span class=\"token keyword\">as</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>__HOW_DEP<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">}</span></span></span>      <span class=\"token punctuation\">/></span></span><span class=\"token punctuation\">,</span>\n      document<span class=\"token punctuation\">.</span>body\n    <span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>And our HTML should now render fine once fully loaded. Amazing!</p>\n<h2>Styling the App, the Lazy Way</h2>\n<p>Revisiting my previous point, I really didn’t feel like creating a <code class=\"language-text\">webpack.config.js</code> file for this project. Having React and Webpack bundled within a CLI tool seemed crazy enough, and I was too lazy to read the docs.</p>\n<p>So when the problem of styling the app came up, importing css files was out of the question.</p>\n<p>Instead, I used good-ol’ <a href=\"https://www.styled-components.com/\">Styled Components</a>. Following their docs I simply had to add the following to my html rederer:</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> ServerStyleSheet <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'styled-components'</span>\n<span class=\"token keyword\">const</span> sheet <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ServerStyleSheet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// ...</span>\n\n<span class=\"token keyword\">const</span> outputAppBody <span class=\"token operator\">=</span> ReactDOMServer<span class=\"token punctuation\">.</span><span class=\"token function\">renderToString</span><span class=\"token punctuation\">(</span>\n  sheet<span class=\"token punctuation\">.</span><span class=\"token function\">collectStyles</span><span class=\"token punctuation\">(</span><span class=\"token comment\">/* script tags and app go here...  */</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> styleTags <span class=\"token operator\">=</span> sheet<span class=\"token punctuation\">.</span><span class=\"token function\">getStyleTags</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> outputHTML <span class=\"token operator\">=</span> styleTags <span class=\"token operator\">+</span> outputAppBody</code></pre></div>\n<h2>Adding a Title and a Favicon</h2>\n<p>Adding both a title and favicon means dealing with the HTML’s <code class=\"language-text\">&lt;head&gt;</code> tag. To do that in SSR world I used <a href=\"https://github.com/nfl/react-helmet\">React Helmet</a>.</p>\n<p>For the favicon to work, I decided to base64 encode it and bake it into a React component. I think I’ve used <a href=\"https://www.base64-image.de/\">this tool</a> for it, though I’m not sure.</p>\n<p><sup>1</sup> How-dep supports JavaScript as well, just provide it with a basic tsconfig.json file</p>\n<div class=\"dependencies\">\n<p><strong>Dependencies:</strong>\n<span class=\"dep\"><a href=\"https://npmjs.com/package/@phenomnomnominal/tsquery\">@phenomnomnominal/tsquery</a></span>\n<span class=\"dep\"><a href=\"https://npmjs.com/package/yargs\">yargs</a></span>\n<span class=\"dep\"><a href=\"https://npmjs.com/package/concurrently\">concurrently</a></span>\n<span class=\"dep\"><a href=\"https://npmjs.com/package/fs-extra\">fs-extra</a></span>\n<span class=\"dep\"><a href=\"https://npmjs.com/package/openurl\">openurl</a></span>\n<span class=\"dep\"><a href=\"https://npmjs.com/package/react\">react</a></span>\n<span class=\"dep\"><a href=\"https://npmjs.com/package/react-dom\">react-dom</a></span>\n<span class=\"dep\"><a href=\"https://npmjs.com/package/react-helmet\">react-helmet</a></span>\n<span class=\"dep\"><a href=\"https://npmjs.com/package/styled-components\">styled-components</a></span>\n<span class=\"dep\"><a href=\"https://npmjs.com/package/temp-dir\">temp-dir</a></span></p>\n</div>","frontmatter":{"title":"Things I've Learnt Building How-Dep","date":"January 03, 2020","description":"Going through some interesting concepts I first encountered when building a CLI tool that “counts your imports” and gives you a rough estimation of how dependent you are of your dependencies"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/building-how-dep/","previous":null,"next":{"fields":{"slug":"/using-vscode/"},"frontmatter":{"title":"Things I've Learnt Using VSCode"}}}}}